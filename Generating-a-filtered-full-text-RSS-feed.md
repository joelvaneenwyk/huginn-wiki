# Generating a filtered full-text RSS feed from an existing limited RSS feed


__Problem__: Your favourite website has a feed but you only wish to read certain types of posts, and their feed only provides summarized text

__Solution__: Use Huginn to create an RSS feed that has filtered full-text content. The workflow to filter posts and fetch full text is as follows:

## Contents

1. [RssAgent](#1-rssagent) - to fetch and parse existing RSS feed
2. [TriggerAgent](#2-rssagent) - to filter feed items
3. [WebsiteAgent](#3-websiteagent) - to fetch full content for feed item
4. [DataOutputAgent](#4-dataoutputagent) - to output RSS

Examples based on [Dilbert](http://dilbert.com/)

## 1. RssAgent

_Name_: 1.Download Dilbert limited feed  

```json
{
  "expected_update_period_in_days": "1",
  "clean": "false",
  "url": "https://dilbert.com/feed"
},
```

> __Note__: find the RSS URL for the site in the HEAD element of the HTML


## 2. TriggerAgent

_Name_: 2.Keep entries with comic strips  
_Event sources_: 1.Download Dilbert limited feed  
_Propagate immediately_: Yes  

```json
{
  "expected_receive_period_in_days": "1",
  "keep_event": "true",
  "rules": [
    {
      "type": "regex",
      "value": ".*strip.*",
      "path": "url"
    }
  ]
}
```

> __Notes__:
> - "keep_event": "true" helps pass on original parsed item elements to next agent
> - the `regex` `value` matches any `url` containing the word "strip", which for us means comic strip items


## 3. WebsiteAgent

_Name_: 3.Get Content  
_Event sources_: 2.Keep entries with comic strips  
_Propagate immediately_: Yes  

``` json
{
  "expected_update_period_in_days": "2",
  "url": "{{url}}",
  "type": "html",
  "mode": "merge",
  "extract": {
    "comictitle": {
      "css": ".comic-title-name",
      "value": "string(.)"
    },
    "comicrating": {
      "css": "div.comic-rating",
      "value": "@data-total"
    },
    "comicimgurl": {
      "xpath": "/html/body/div/div[4]/div[1]/div/div[2]/div/section/div[3]/a/img",
      "value": "@src"
    }
  }
}
```

> __Notes__: 
> - "mode": "merge" helps pass on original parsed item elements to next agent
> - use "Dry Run" here to confirm you are getting the same, correct number of each element
> - we want the `string` value of the element with the class `comic-title-name`
> - we want the `data-total` attribute of the `div` with the class `comic-rating`
> - we want the `src` attribute of the image located at the given `xpath`
> - the "xpath" is obtained using the browser web inspector, as follows:
>   1. open web inspector
>   1. in the html source, find the element you are interested in
>   1. right click on the element to show the context menu
>   1. choose Copy > XPath


## 4. DataOutputAgent

_Name_: 4.Output RSS  
_Event sources_: 3.Get Content  
_Propagate immediately_: Yes  

```json
{
  "secrets": [
    "dilbert-full-feed"
  ],
  "expected_receive_period_in_days": "1",
  "events_order": [
    [
      "{{id}}",
      "string",
      "false"
    ]
  ],
  "template": {
    "title": "Dilbert full feed",
    "description": "This is a feed of recent Dilbert comics, generated by Huginn",
    "item": {
      "title": "{{title}}",
      "description": "<p><em>{{comictitle}}</em></p><p>Rating: {{comicrating}}</p><p><a href=\"{{url}}\"><img src=\"{{comicimgurl}}\"></a></p>",
      "link": "{{url}}",
      "date_published": "{{last_updated}}",
      "pubDate": "{{last_updated}}"
    }
  },
  "ns_media": "true"
}
```

> __Notes__:
> - "event_order" is needed to keep the items in the initial collection of items in the correct order on first subscription
> - we're ordering by the "id" field, which is a date "string", and not sorting in reverse "false"
> - we write a small amount of HTML for the body/description of the item containing the `comictitle`, `comicrating`, and the `comicimageurl` wrapped in a link to `url` the comic page
> - to ensure all items are correctly dated we set both `date_published` and `pubDate` to the `last_updated` value which is present in the original feed
> - __bonus__: if the time we had was not formatted correctly we could do something like: `"pubDate": "{{timestamp | date: '%a, %d %b %Y %H:%M:%S %z'}}"` to get from a Unix timestamp to the date format expected in an RSS feed.


## Scenario

This json file can be imported directly into Huginn: [dilbert-full-feed.json](https://github.com/huginn/huginn/files/8056832/dilbert-full-feed.json.txt)
 